Implement Firebase Push Notifications for Toothfile
Overview
Implement Firebase Cloud Messaging (FCM) push notifications in the Toothfile Flutter app. Notifications are triggered server-side via Supabase database triggers, so the Flutter app only needs to:

Request notification permission
Get and store the FCM token
Handle incoming notifications
Allow users to manage notification preferences
Firebase Configuration
Project ID: toothfile-61f5e


// Firebase config (for reference)
const firebaseConfig = {
  apiKey: "AIzaSyA4_oADw_0aiaY0-kmrXNTEBgVQOm7wkQQ",
  authDomain: "toothfile-61f5e.firebaseapp.com",
  projectId: "toothfile-61f5e",
  storageBucket: "toothfile-61f5e.firebasestorage.app",
  messagingSenderId: "774900813610",
  appId: "1:774900813610:web:acf875d59e15ed45b15853",
};
Supabase Configuration
Project URL: https://ikqsbkfnjamvkevsxqpr.supabase.co Anon Key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrcXNia2ZuamFtdmtldnN4cXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNTUxMDMsImV4cCI6MjA2NTkzMTEwM30.fhRMXkOu8WAD6B_zMCe1xBI6E_Ql4pRzRnfJHZS7qPM

Implementation Steps
1. FCM Token Management
Store the FCM token in the profiles table when the user enables notifications:


// After getting FCM token from FirebaseMessaging
final fcmToken = await FirebaseMessaging.instance.getToken();

// Save to Supabase profiles table
await supabase
  .from('profiles')
  .update({'fcm_token': fcmToken})
  .eq('id', currentUserId);

// To disable notifications, set token to null
await supabase
  .from('profiles')
  .update({'fcm_token': null})
  .eq('id', currentUserId);
2. Notification Types & Deep Linking
Handle these 4 notification types in the data payload:

Type	Data Payload	Navigate To
file_received	{type: 'file_received', fileId: '...'}	Received Files screen
file_tracker	{type: 'file_tracker', eventType: 'downloaded'}	File Tracker screen
connection_request	{type: 'connection_request', requestId: '...'}	Connections/Settings screen
connection_accepted	{type: 'connection_accepted', requestId: '...'}	User Directory screen

// Handle notification tap
void handleNotificationTap(Map<String, dynamic> data) {
  final type = data['type'];
  switch (type) {
    case 'file_received':
      // Navigate to Received Files tab
      break;
    case 'file_tracker':
      // Navigate to File Tracker tab
      break;
    case 'connection_request':
      // Navigate to Settings/Connections
      break;
    case 'connection_accepted':
      // Navigate to User Directory
      break;
  }
}
3. User Notification Preferences
Table: notification_preferences


// Notification preference model
class NotificationPreferences {
  final bool emailNotifications;     // Master email toggle
  final bool fileReceived;           // When someone sends you a file
  final bool fileTracker;            // When your file is downloaded
  final bool connectionRequests;     // When someone sends connection request
  final bool connectionAccepted;     // When your request is accepted
  final bool fileExpiration;         // File expiry warnings
  final bool weeklyDigest;           // Weekly summary
  final bool marketingEmails;        // Marketing
}

// Fetch preferences
final response = await supabase
  .from('notification_preferences')
  .select()
  .eq('user_id', userId)
  .maybeSingle();

// Update preferences
await supabase
  .from('notification_preferences')
  .upsert({
    'user_id': userId,
    'file_received': true,
    'file_tracker': true,
    'connection_requests': true,
    'connection_accepted': true,
  });
4. Notification Settings UI
Create a settings screen with toggles for:

Push Notifications (master toggle - enables/disables FCM token)
File Received - "Notify when someone sends you a file"
File Tracker - "Notify when someone downloads your file"
Connection Requests - "Notify when someone wants to connect"
Connection Accepted - "Notify when your request is accepted"
The master "Push Notifications" toggle should:

ON: Request permission, get FCM token, save to profiles.fcm_token
OFF: Set profiles.fcm_token to null
5. Manual Notification Sending (Optional)
To send a test notification or custom notification, call the edge function:


await supabase.functions.invoke('send-fcm-notification', body: {
  'userId': recipientUserId,
  'title': 'Notification Title',
  'body': 'Notification body text',
  'data': {'type': 'file_received', 'fileId': '123'}
});
6. Background Message Handler

// Top-level function (outside any class)
@pragma('vm:entry-point')
Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp();
  print('Background message: ${message.messageId}');
}

// In main.dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);
  runApp(MyApp());
}
7. Foreground Message Handler

FirebaseMessaging.onMessage.listen((RemoteMessage message) {
  // Show local notification using flutter_local_notifications
  final notification = message.notification;
  if (notification != null) {
    flutterLocalNotificationsPlugin.show(
      notification.hashCode,
      notification.title,
      notification.body,
      NotificationDetails(
        android: AndroidNotificationDetails(
          'toothfile_channel',
          'Toothfile Notifications',
          importance: Importance.high,
          priority: Priority.high,
          icon: '@mipmap/ic_launcher',
        ),
        iOS: DarwinNotificationDetails(),
      ),
      payload: jsonEncode(message.data),
    );
  }
});
Required Packages

dependencies:
  firebase_core: ^latest
  firebase_messaging: ^latest
  flutter_local_notifications: ^latest
  supabase_flutter: ^latest
Platform Setup
Android: Add google-services.json to android/app/ iOS: Add GoogleService-Info.plist to ios/Runner/

Both files are available from Firebase Console → Project Settings → Your Apps.

Important Notes
Notifications are server-triggered - You don't need to send notifications from Flutter. Supabase database triggers automatically send FCM notifications when files are shared, downloaded, or connection requests change.

FCM token is the key - As long as the user's FCM token is stored in profiles.fcm_token, they will receive notifications.

User preferences are respected - The server checks notification_preferences before sending each notification type.

App icon - Use the Toothfile logo for notification icons (/toothfile-logo.png).