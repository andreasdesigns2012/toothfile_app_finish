 1import 'dart:convert';
 2import 'dart:io';
 3
 4import 'package:shelf/shelf.dart';
 5import 'package:shelf/shelf_io.dart' as io;
 6import 'package:http/http.dart' as http;
 7
 8// Environment variable
 9final resendApiKey = Platform.environment['RESEND_API_KEY'];
10
11final corsHeaders = {
12  "Access-Control-Allow-Origin": "*",
13  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
14};
15
16class InvitationRequest {
17  final String inviterName;
18  final String inviterEmail;
19  final String inviterRole;
20  final String recipientEmail;
21  final String? personalMessage;
22
23  InvitationRequest({
24    required this.inviterName,
25    required this.inviterEmail,
26    required this.inviterRole,
27    required this.recipientEmail,
28    this.personalMessage,
29  });
30
31  factory InvitationRequest.fromJson(Map<String, dynamic> json) {
32    return InvitationRequest(
33      inviterName: json['inviterName'],
34      inviterEmail: json['inviterEmail'],
35      inviterRole: json['inviterRole'],
36      recipientEmail: json['recipientEmail'],
37      personalMessage: json['personalMessage'],
38    );
39  }
40}
41
42Future<Response> handler(Request request) async {
43  // Handle CORS preflight
44  if (request.method == 'OPTIONS') {
45    return Response.ok('', headers: corsHeaders);
46  }
47
48  try {
49    final payload = await request.readAsString();
50    final data = json.decode(payload) as Map<String, dynamic>;
51    final invitation = InvitationRequest.fromJson(data);
52
53    final roleText = invitation.inviterRole == 'dental' ? 'dentist' : 'dental technician';
54    final appUrl = "https://toothfile.com/";
55
56    final htmlContent = '''
57<!DOCTYPE html>
58<html>
59<head>
60  <meta charset="utf-8">
61  <title>Join ${invitation.inviterName} on ToothFile</title>
62  <style>
63    /* ... (same styles as in TypeScript) ... */
64  </style>
65</head>
66<body>
67<div class="container">
68  <div class="header">
69    <div class="logo">ðŸ¦· ToothFile</div>
70    <p style="margin: 0; font-size: 18px;">Secure Dental Collaboration Platform</p>
71  </div>
72  <div class="content">
73    <h2 style="color: #1f2937; margin-top: 0;">You're Invited to Join ToothFile!</h2>
74    <p>Hello!</p>
75    <p><strong>${invitation.inviterName}</strong> has invited you to join ToothFile, a secure platform designed specifically for dental professionals to share files safely.</p>
76    ${invitation.personalMessage != null ? '''
77    <div class="personal-message">
78      <strong>Personal message from ${invitation.inviterName}:</strong><br>
79      "${invitation.personalMessage}"
80    </div>
81    ''' : ''}
82    <div class="highlight">
83      <h3 style="margin-top: 0; color: #2563eb;">What is ToothFile?</h3>
84      <p>ToothFile is a specialized platform that enables secure file sharing between dentists and dental technicians. Share patient files and dental scans while maintaining the highest security standards.</p>
85    </div>
86    <div class="features">
87      <h3 style="margin-top: 0; color: #1f2937;">What you can do with ToothFile:</h3>
88      <div class="feature-item">Securely share dental files</div>
89      <div class="feature-item">Collaborate in real-time with dental professionals</div>
90      <div class="feature-item">Track file delivery and access with detailed notifications</div>
91      <div class="feature-item">Connect with dentists and dental technicians</div>
92      <div class="feature-item">Maintain patient privacy with security</div>
93      <div class="feature-item">Access to ToothFile from any device, anywhere</div>
94    </div>
95    <div style="text-align: center; margin: 30px 0;">
96      <a href="$appUrl" class="cta-button">Join ToothFile Now</a>
97    </div>
98    <p style="color: #6b7280; font-size: 14px;">
99      Getting started is easy! Click the button above to create your free account and start collaborating with ${invitation.inviterName} and other dental professionals securely.
100    </p>
101    <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
102    <p style="font-size: 14px; color: #6b7280;">
103      This invitation was sent by <strong>${invitation.inviterName}</strong> (${invitation.inviterEmail}) who is already using ToothFile to streamline their dental workflow.
104    </p>
105  </div>
106  <div class="footer">
107    <p style="margin: 0;">
108      <strong>ToothFile</strong> - Secure Dental Collaboration<br> Connecting dentists and dental technicians
109    </p>
110    <p style="margin: 10px 0 0 0; font-size: 12px;">
111      If you have any questions, feel free to reply to this email.
112    </p>
113  </div>
114</div>
115</body>
116</html>
117''';
118
119    final emailPayload = {
120      "from": "ToothFile <onboarding@resend.dev>",
121      "to": [invitation.recipientEmail],
122      "subject": "${invitation.inviterName} invited you to join ToothFile",
123      "html": htmlContent,
124      "reply_to": invitation.inviterEmail
125    };
126
127    final emailResponse = await http.post(
128      Uri.parse('https://api.resend.com/emails'),
129      headers: {
130        'Authorization': 'Bearer $resendApiKey',
131        'Content-Type': 'application/json',
132      },
133      body: json.encode(emailPayload),
134    );
135
136    if (emailResponse.statusCode == 200) {
137      final respBody = json.decode(emailResponse.body) as Map<String, dynamic>;
138      return Response.ok(json.encode({"success": true, "id": respBody['data']?['id']}), headers: {
139        ...corsHeaders,
140        "Content-Type": "application/json"
141      });
142    } else {
143      final respBody = json.decode(emailResponse.body);
144      return Response.internalServerError(
145        body: json.encode({"error": respBody['error'] ?? 'Failed to send email'}),
146        headers: {
147          ...corsHeaders,
148          "Content-Type": "application/json"
149        }
150      );
151    }
152  } catch (e) {
153    return Response.internalServerError(
154      body: json.encode({"error": e.toString()}),
155      headers: {
156        ...corsHeaders,
157        "Content-Type": "application/json"
158      }
159    );
160  }
161}
162
163void main(List<String> args) async {
164  final handlerWithCors = const Pipeline()
165      .addMiddleware(logRequests())
166      .addHandler(handler);
167
168  final port = int.parse(Platform.environment['PORT'] ?? '8080');
169  final server = await io.serve(handlerWithCors, InternetAddress.anyIPv4, port);
170  print('Server listening on port ${server.port}');
171}
